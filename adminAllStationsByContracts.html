<!DOCTYPE html>
<html ng-app>
    <head>
        <meta charset="UTF-8">
        <title>test</title>
    </head>
    <body ng-controller="ContractsController">
        <button ng-click="readContracts()">readContracts</button>
        {{recup | json}}
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.6/angular.min.js"></script>
        <script> 
function ContractsController($scope, $http){
    var jswait = function (millisec){
        var date = new Date();
        var tampon = null;
        do { tampon = new Date(); } 
        while(tampon-date < millisec);
    }; 
    $scope.readContracts = function(){
            $scope.recup = [];
            $http({method: 'GET', url: 'http://cycles.lizazil.com/database/api/1/databases/mytest/collections/contracts'}).
            success(function(data, status, headers, config) {
                 $scope.contracts = angular.fromJson(data);
                 var compteur = 0;
                 $scope.contracts.forEach(function(contract) {
                    $http({method: 'GET', url: 'http://cycles.lizazil.com/jcdecaux/vls/v1/stations?contract='+contract.name}).
                    success(function(data, status, headers, config) {
                                    geo = angular.fromJson(data);
                                    geo.forEach(
                                        function(myDoc) { 
                                        var geodata = {};
                                        geodata.contract = contract.name;
                                        geodata.number = myDoc.number;
                                        geodata.name = myDoc.name;
                                        geodata.position = myDoc.position;
                                        geodata.coordinates = [];
                                        geodata.coordinates.push(myDoc.position.lng,myDoc.position.lat);
                                        $scope.recup.push(geodata);
                                    });
                    jswait(150);
                    }).
                    error(function(data, status, headers, config) {
                    debugger;
                    });  
                 });
            }).
            error(function(data, status, headers, config) {
            debugger;
            });
    };
 };    
 </script>
    </body>
</html>